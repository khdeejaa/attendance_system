{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Dashboard - College Attendance Tracker{% endblock %}

{% block extra_css %}
<style>
    .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        border-left: 4px solid #27ae60;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }

    .card-icon {
        font-size: 24px;
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
    }

    .card-content {
        color: #7f8c8d;
        line-height: 1.5;
    }

    .btn {
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
    }

    .btn:hover {
        background: #219a52;
    }

    .btn-secondary {
        background: #3498db;
    }

    .btn-secondary:hover {
        background: #2980b9;
    }

    .btn-warning {
        background: #f39c12;
    }

    .btn-warning:hover {
        background: #e67e22;
    }

    .btn-danger {
        background: #e74c3c;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .attendance-section {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 15px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-weight: 500;
        margin-bottom: 5px;
        color: #2c3e50;
    }

    .filters select, .filters input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .filters select:focus, .filters input:focus {
        outline: none;
        border-color: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
    }

    .attendance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .attendance-table th,
    .attendance-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
    }

    .attendance-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        position: sticky;
        top: 0;
    }

    .attendance-table tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-present {
        background: #d4edda;
        color: #155724;
    }

    .status-absent {
        background: #f8d7da;
        color: #721c24;
    }

    .status-absent-w-permissions {
        background: #f8d7da;
        color: #721c24;
    }

    .status-late {
        background: #fff3cd;
        color: #856404;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        margin: 2% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 95vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        border: 1px solid rgba(255,255,255,0.2);
        animation: modalSlideIn 0.3s ease-out;
        position: relative;
    }

    /* Custom scrollbar for modal */
    .modal-content::-webkit-scrollbar {
        width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 25px 30px;
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .modal-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modal-header h3::before {
        content: '✏️';
        font-size: 28px;
    }

    .modal-body {
        padding: 30px;
        background: #ffffff;
        border-radius: 0 0 20px 20px;
        max-height: none;
        overflow: visible;
    }

    .close {
        font-size: 28px;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }

    .close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
        color: white;
    }

    .form-group {
        margin-bottom: 25px;
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group label::before {
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        font-size: 16px;
        color: #007bff;
    }

    .form-group label[for="editStudentName"]::before {
        content: '\f007'; /* user icon */
    }

    .form-group label[for="editSubject"]::before {
        content: '\f02d'; /* book icon */
    }

    .form-group label[for="editDate"]::before {
        content: '\f073'; /* calendar icon */
    }

    .form-group label[for="editStatus"]::before {
        content: '\f058'; /* check-circle icon */
    }

    .form-group label[for="editTimeSlot"]::before {
        content: '\f017'; /* clock icon */
    }

    .form-control {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #ffffff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        transform: translateY(-2px);
    }

    .form-control:read-only {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #6c757d;
        cursor: not-allowed;
    }

    .form-control option {
        padding: 10px;
    }

    .form-actions {
        margin-top: 25px;
        padding: 20px 0 0 0;
        border-top: 2px solid #f8f9fa;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        position: sticky;
        bottom: 0;
        background: #ffffff;
        z-index: 10;
    }

    .btn-modal {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
        justify-content: center;
    }

    .btn-modal:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .btn-save:hover {
        background: linear-gradient(135deg, #218838 0%, #1c7c6c 100%);
    }

    .btn-cancel {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
    }

    .btn-cancel:hover {
        background: linear-gradient(135deg, #5a6268 0%, #494f54 100%);
    }

    /* Add subtle pulse animation for focused form elements */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        }
        50% {
            box-shadow: 0 0 0 6px rgba(0, 123, 255, 0.2);
        }
        100% {
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
        }
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        animation: pulse 2s infinite;
        transform: translateY(-2px);
    }

    /* Add hover effects for better interactivity */
    .form-control:hover:not(:read-only) {
        border-color: #80bdff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Smooth transitions for all interactive elements */
    * {
        transition: all 0.2s ease;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .error-message {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border-left: 4px solid #dc3545;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
    }

    .error-message::before {
        content: '⚠️';
        font-size: 18px;
    }

    .success-message {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        padding: 15px 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
        animation: successSlideIn 0.5s ease-out;
    }

    .success-message::before {
        content: '✅';
        font-size: 18px;
    }

    @keyframes successSlideIn {
        from {
            transform: translateX(-20px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .student-attendance {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 3px solid #27ae60;
    }

    /* Active navigation styles */
    .nav-link.active {
        background-color: #007bff !important;
        color: white !important;
        border-radius: 5px;
    }

    .nav-link.submenu-link.active {
        background-color: #007bff !important;
        color: white !important;
        margin-left: 10px;
        border-radius: 5px;
    }

    @media (max-width: 768px) {
        .dashboard-cards {
            grid-template-columns: 1fr;
        }

        .filters {
            grid-template-columns: 1fr;
        }

        .attendance-table {
            font-size: 12px;
        }

        .modal-content {
            width: 95%;
            margin: 1% auto;
            max-height: 98vh;
            border-radius: 15px;
        }

        .modal-header {
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-body {
            padding: 20px;
            border-radius: 0 0 15px 15px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .form-actions {
            flex-direction: column;
            gap: 12px;
        }

        .btn-modal {
            width: 100%;
            padding: 15px;
        }

        .form-control {
            padding: 12px 15px;
            font-size: 14px;
        }

        .form-group label {
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block sidebar_menu %}
<!-- Staff-specific menu items -->
<a class="nav-link" id="dashboardLink" href="#" onclick="showDashboard(); setActiveNav('dashboardLink')">
    <i class="fas fa-tachometer-alt me-2"></i>
    Dashboard
</a>

<!-- Attendance Section -->
<div class="sidebar-section">
    <a class="nav-link collapsed" data-bs-toggle="collapse" href="#attendanceCollapse" role="button" aria-expanded="true" aria-controls="attendanceCollapse">
        <i class="fas fa-check-circle me-2"></i>
        Attendance
        <i class="fas fa-chevron-down float-end mt-1"></i>
    </a>
    <div class="collapse show" id="attendanceCollapse">
        <div class="submenu">
            <a class="nav-link submenu-link" id="markAttendanceLink" href="#" onclick="showMarkAttendance(); setActiveNav('markAttendanceLink')">
                <i class="fas fa-plus me-2"></i>
                Mark Attendance
            </a>
            <a class="nav-link submenu-link" id="viewRecordsLink" href="#" onclick="showViewAttendance(); setActiveNav('viewRecordsLink')">
                <i class="fas fa-eye me-2"></i>
                Manage Records
            </a>
          
        </div>
    </div>
</div>

<hr class="bg-light">

<!-- Logout -->
<a class="nav-link text-danger" href="{% url 'staff_logout' %}">
    <i class="fas fa-sign-out-alt me-2"></i>
    Logout
</a>
{% endblock %}

{% block page_title %}Staff Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Cards -->
<div class="dashboard-cards">
    <div class="card">
        <div class="card-header">
            <span class="card-icon">✅</span>
            <h3 class="card-title">Mark Attendance</h3>
        </div>
        <div class="card-content">
            Take attendance for your classes. Select a subject and mark students as present, absent, or late.
            <br>
            <button class="btn" onclick="showMarkAttendance(); setActiveNav('markAttendanceLink')">📝 Mark Attendance</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="card-icon">🔍</span>
            <h3 class="card-title">Manage Attendance</h3>
        </div>
        <div class="card-content">
            Manage attendance records by subject, date, or student. Generate reports for analysis.
            <br>
            <button class="btn btn-secondary" onclick="showViewAttendance(); setActiveNav('viewRecordsLink')">👀 View Attendance</button>
        </div>
    </div>

    </div>
</div>

<!-- Mark Attendance Section -->
<div id="markAttendanceSection" class="attendance-section" style="display: none;">
    <div class="section-header">
        <h2 class="section-title">✅ Mark Attendance</h2>
    </div>
    <form method="POST" action="{% url 'mark_attendance' %}">
        {% csrf_token %}
        <div class="filters">
            <div class="filter-group">
                <label for="subjectSelect">Select Subject:</label>
                <select id="subjectSelect" name="subject_id" onchange="loadStudentsForAttendance()" required>
                    <option value="">Choose a subject...</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.subject_code }} - {{ subject.subject_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="classSelect">Select Class:</label>
                <select id="classSelect" name="class_id" onchange="loadStudentsForAttendance()" required>
                    <option value="">Choose a class...</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}">{{ class.class_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="attendanceDate">Date:</label>
                <input type="date" id="attendanceDate" name="date" onchange="checkExistingAttendance()" required>
            </div>
            
            <div class="filter-group">
                <label for="timeSlot">Time Slot:</label>
                <select id="timeSlot" name="time_slot" onchange="checkExistingAttendance()" required>
                    <option value="09:00-10:00">09:00 - 10:00 AM</option>
                    <option value="10:00-11:00">10:00 - 11:00 AM</option>
                    <option value="11:00-12:00">11:00 - 12:00 PM</option>
                    <option value="14:00-15:00">02:00 - 03:00 PM</option>
                    <option value="15:00-16:00">03:00 - 04:00 PM</option>
                </select>
            </div>
        </div>

        <div id="studentsForAttendance">
            <div class="empty-state">
                <i class="fas fa-info-circle"></i>
                <p>Please select both subject and class to load students.</p>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn" onclick="return validateAttendanceForm()">💾 Save Attendance</button>
            <button type="button" class="btn btn-secondary" onclick="clearAttendance()">🔄 Clear Form</button>
        </div>
    </form>
</div>

<!-- View Attendance Section -->
<div id="viewAttendanceSection" class="attendance-section" style="display: none;">
    <div class="section-header">
        <h2 class="section-title">🔍 Manage Attendance Records</h2>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label for="filterSubject">Filter by Subject:</label>
            <select id="filterSubject" onchange="filterAttendance()">
                <option value="">All Subjects</option>
                {% for subject in subjects %}
                    <option value="{{ subject.subject_code }}">{{ subject.subject_code }} - {{ subject.subject_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="filterClass">Filter by Class:</label>
            <select id="filterClass" onchange="filterAttendance()">
                <option value="">All Classes</option>
                {% for class in classes %}
                    <option value="{{ class.class_name }}">{{ class.class_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="filterDate">Filter by Date:</label>
            <input type="date" id="filterDate" onchange="filterAttendance()">
        </div>
        <div class="filter-group">
            <label for="filterStudent">Filter by Student ID:</label>
            <input type="text" id="filterStudent" placeholder="Enter student ID..." onkeyup="filterAttendance()">
        </div>
    </div>

    <table class="attendance-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Time Slot</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="attendanceTableBody">
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <i class="fas fa-spinner fa-spin"></i> Loading attendance records...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Edit Attendance Section -->
<div id="editAttendanceSection" class="attendance-section" style="display: none;">
    <div class="section-header">
        <h2 class="section-title">✏️ Edit Attendance Records</h2>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label for="searchStudent">Search Student:</label>
            <input type="text" id="searchStudent" placeholder="Enter student name or ID..." onkeyup="searchStudentRecords()">
        </div>
    </div>

    <div id="editableRecords">
        <div class="empty-state">
            <div class="empty-state-icon">🔍</div>
            <p>Enter student name or ID to search for records.</p>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Attendance Record</h3>
            <button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editForm" onsubmit="submitEditForm(event)">
                {% csrf_token %}
                <input type="hidden" id="editRecordId" name="record_id">
                
                <div class="form-group">
                    <label for="editStudentName">Student Name</label>
                    <input type="text" id="editStudentName" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label for="editSubject">Subject</label>
                    <input type="text" id="editSubject" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" name="date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editStatus">Attendance Status</label>
                    <select id="editStatus" name="status" class="form-control" required>
                        <option value="Present">✅ Present</option>
                        <option value="Absent w permissions">❌ Absent w permissions</option>
                        <option value="Late">⏰ Late</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editTimeSlot">Time Slot</label>
                    <select id="editTimeSlot" name="time_slot" class="form-control" required>
                        <option value="09:00-10:00">🌅 09:00 - 10:00 AM</option>
                        <option value="10:00-11:00">☀️ 10:00 - 11:00 AM</option>
                        <option value="11:00-12:00">🌞 11:00 - 12:00 PM</option>
                        <option value="14:00-15:00">🌤️ 02:00 - 03:00 PM</option>
                        <option value="15:00-16:00">🌆 03:00 - 04:00 PM</option>
                    </select>
                </div>
                
                <div id="editFormMessage"></div>
                
                <div class="form-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeEditModal()">
                        ❌ Cancel
                    </button>
                    <button type="submit" class="btn-modal btn-save">
                        💾 Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('attendanceDate');
    if (dateInput) {
        dateInput.value = today;
    }
    
    // Set dashboard as active by default
    setActiveNav('dashboardLink');
});

// Function to set active navigation
function setActiveNav(activeId) {
    // Remove active class from all nav links
    const allNavLinks = document.querySelectorAll('.nav-link');
    allNavLinks.forEach(link => {
        link.classList.remove('active');
    });
    
    // Add active class to clicked nav item
    const activeLink = document.getElementById(activeId);
    if (activeLink) {
        activeLink.classList.add('active');
    }
}

// Show Dashboard (cards view)
function showDashboard() {
    hideAllSections();
    // Show dashboard cards (they're always visible unless a section is shown)
}

// Show Mark Attendance Section
function showMarkAttendance() {
    hideAllSections();
    // Hide dashboard cards
    const dashboardCards = document.querySelector('.dashboard-cards');
    if (dashboardCards) {
        dashboardCards.style.display = 'none';
    }
    document.getElementById('markAttendanceSection').style.display = 'block';
    setActiveNav('markAttendanceLink');
}

// Show View Attendance Section
function showViewAttendance() {
    hideAllSections();
    // Hide dashboard cards
    const dashboardCards = document.querySelector('.dashboard-cards');
    if (dashboardCards) {
        dashboardCards.style.display = 'none';
    }
    document.getElementById('viewAttendanceSection').style.display = 'block';
    loadAllAttendanceRecords();
    setActiveNav('viewRecordsLink');
}

// Show Edit Attendance Section
function showEditAttendance() {
    hideAllSections();
    // Hide dashboard cards
    const dashboardCards = document.querySelector('.dashboard-cards');
    if (dashboardCards) {
        dashboardCards.style.display = 'none';
    }
    document.getElementById('editAttendanceSection').style.display = 'block';
    setActiveNav('editRecordsLink');
}

// Hide all sections
function hideAllSections() {
    document.getElementById('markAttendanceSection').style.display = 'none';
    document.getElementById('viewAttendanceSection').style.display = 'none';
    document.getElementById('editAttendanceSection').style.display = 'none';
    
    // Show or hide dashboard cards
    const dashboardCards = document.querySelector('.dashboard-cards');
    if (dashboardCards) {
        // Only show dashboard cards if no specific section is being shown
        const anySectionVisible = document.getElementById('markAttendanceSection').style.display !== 'none' ||
                                  document.getElementById('viewAttendanceSection').style.display !== 'none' ||
                                  document.getElementById('editAttendanceSection').style.display !== 'none';
        dashboardCards.style.display = anySectionVisible ? 'none' : 'grid';
    }
}

// Validate attendance form before submission
function validateAttendanceForm() {
    const disabledStudents = document.querySelectorAll('.student-attendance[style*="pointer-events: none"]');
    const enabledStudents = document.querySelectorAll('.student-attendance:not([style*="pointer-events: none"])');
    
    if (disabledStudents.length > 0 && enabledStudents.length === 0) {
        alert('⚠️ Cannot save attendance: All students already have attendance marked for this date and time slot. This would create duplicate records which is not allowed.');
        return false;
    }
    
    if (enabledStudents.length === 0) {
        alert('⚠️ No students available to mark attendance. Please select a subject and class first.');
        return false;
    }
    
    const subjectSelect = document.getElementById('subjectSelect');
    const classSelect = document.getElementById('classSelect');
    const dateInput = document.getElementById('attendanceDate');
    const timeSlotSelect = document.getElementById('timeSlot');
    
    if (!subjectSelect.value || !classSelect.value || !dateInput.value || !timeSlotSelect.value) {
        alert('⚠️ Please fill in all required fields: Subject, Class, Date, and Time Slot.');
        return false;
    }
    
    // Count enabled students with attendance selections
    let studentsToSave = 0;
    enabledStudents.forEach(student => {
        const select = student.querySelector('.attendance-status');
        if (select && select.value) {
            studentsToSave++;
        }
    });
    
    if (studentsToSave === 0) {
        alert('⚠️ No students selected for attendance marking.');
        return false;
    }
    
    // Check if there are any disabled students (duplicates)
    if (disabledStudents.length > 0) {
        const confirmMessage = `⚠️ Warning: ${disabledStudents.length} student(s) already have attendance marked and will be skipped.\n\n✅ ${studentsToSave} new student(s) will be saved.\n\nDate: ${dateInput.value}\nTime Slot: ${timeSlotSelect.options[timeSlotSelect.selectedIndex].text}\nSubject: ${subjectSelect.options[subjectSelect.selectedIndex].text}\n\nContinue with saving the new records only?`;
        return confirm(confirmMessage);
    } else {
        // No duplicates, normal confirmation
        const confirmMessage = `✅ Ready to save attendance for ${studentsToSave} student(s).\n\nDate: ${dateInput.value}\nTime Slot: ${timeSlotSelect.options[timeSlotSelect.selectedIndex].text}\nSubject: ${subjectSelect.options[subjectSelect.selectedIndex].text}\n\nContinue?`;
        return confirm(confirmMessage);
    }
}

// Clear Attendance Form
function clearAttendance() {
    const selects = document.querySelectorAll('.attendance-status');
    selects.forEach(select => select.value = 'Present');
    
    // Also clear the student container
    document.getElementById('studentsForAttendance').innerHTML = '<div class="empty-state"><i class="fas fa-info-circle"></i><p>Please select both subject and class to load students.</p></div>';
    
    // Reset form selects
    document.getElementById('subjectSelect').value = '';
    document.getElementById('classSelect').value = '';
    document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('timeSlot').value = '';
}

// Load Students for Attendance
function loadStudentsForAttendance() {
    const subjectSelect = document.getElementById('subjectSelect');
    const classSelect = document.getElementById('classSelect');
    const selectedSubject = subjectSelect.value;
    const selectedClass = classSelect.value;
    const container = document.getElementById('studentsForAttendance');

    // Clear container first
    container.innerHTML = '';

    // Check if both subject and class are selected
    if (!selectedSubject || !selectedClass) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-info-circle"></i><p>Please select both subject and class to load students.</p></div>';
        return;
    }

    // Show loading state
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';

    // Construct the API URL
    const apiUrl = `/api/students-for-class/${selectedSubject}/${selectedClass}/`;

    // Fetch students for the selected class and subject
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;
                return;
            }

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No students found for this class.</p></div>';
                return;
            }

            // Build the HTML for student list
            let html = '<h5><i class="fas fa-users"></i> Students in this class:</h5>';
            data.forEach(student => {
                html += `
                    <div class="student-attendance" data-student-id="${student.id}">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Name:</strong> ${student.student_name}
                            </div>
                            <div class="col-md-3">
                                <strong>Student ID:</strong> ${student.student_id}
                            </div>
                            <div class="col-md-5">
                                <div class="filter-group">
                                    <label>Status:</label>
                                    <select name="attendance_${student.id}" class="form-select attendance-status" required>
                                        <option value="Present">Present</option>
                                        <option value="Absent w permissions">Absent w permissions</option>
                                        <option value="Late">Late</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="existing-record-warning" style="display: none; margin-top: 10px;">
                            <div class="error-message">
                                ⚠️ Attendance already exists for this student on this date and time slot!
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Check for existing attendance records
            checkExistingAttendance();
        })
        .catch(error => {
            console.error('Error loading students:', error);
            container.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Error loading students: ${error.message}
                </div>
            `;
        });
}

// Check for existing attendance records
async function checkExistingAttendance() {
    const subjectSelect = document.getElementById('subjectSelect');
    const classSelect = document.getElementById('classSelect');
    const dateInput = document.getElementById('attendanceDate');
    const timeSlotSelect = document.getElementById('timeSlot');
    
    const selectedSubject = subjectSelect.value;
    const selectedClass = classSelect.value;
    const selectedDate = dateInput.value;
    const selectedTimeSlot = timeSlotSelect.value;
    
    if (!selectedSubject || !selectedClass || !selectedDate || !selectedTimeSlot) {
        return;
    }
    
    try {
        const response = await fetch(`/api/check-existing-attendance/?subject_id=${selectedSubject}&class_id=${selectedClass}&date=${selectedDate}&time_slot=${encodeURIComponent(selectedTimeSlot)}`);
        
        if (response.ok) {
            const existingRecords = await response.json();
            
            // Reset all student cards
            document.querySelectorAll('.student-attendance').forEach(card => {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
                card.querySelector('.existing-record-warning').style.display = 'none';
                card.querySelector('.attendance-status').disabled = false;
            });
            
            // Mark students with existing attendance
            existingRecords.forEach(record => {
                const studentCard = document.querySelector(`[data-student-id="${record.student_id}"]`);
                if (studentCard) {
                    studentCard.style.opacity = '0.6';
                    studentCard.style.pointerEvents = 'none';
                    studentCard.querySelector('.existing-record-warning').style.display = 'block';
                    studentCard.querySelector('.attendance-status').disabled = true;
                    
                    // Update the warning message with specific details
                    const warningDiv = studentCard.querySelector('.existing-record-warning .error-message');
                    warningDiv.innerHTML = `⚠️ Attendance already marked as "${record.status}" for this student on ${record.date} at ${record.time_slot}`;
                }
            });
        }
    } catch (error) {
        console.error('Error checking existing attendance:', error);
    }
}

// Filter Attendance Records
// Updated Filter Attendance Records function
function filterAttendance() {
    const filterSubject = document.getElementById('filterSubject').value.toLowerCase();
    const filterClass = document.getElementById('filterClass').value.toLowerCase();
    const filterDate = document.getElementById('filterDate').value;
    const filterStudent = document.getElementById('filterStudent').value.toLowerCase();

    const tbody = document.getElementById('attendanceTableBody');
    if (!tbody) return;

    const rows = tbody.getElementsByTagName('tr');
    let visibleRowCount = 0;

    // Remove any existing "no records found" message
    const existingNoRecordsMsg = tbody.querySelector('.no-records-message');
    if (existingNoRecordsMsg) {
        existingNoRecordsMsg.remove();
    }

    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length === 0) continue;
        
        // Skip if this is the loading/empty state row
        if (cells.length === 1 && cells[0].getAttribute('colspan')) continue;

        const date = cells[0].textContent;
        const studentId = cells[1].textContent.toLowerCase();
        const studentName = cells[2].textContent.toLowerCase();
        const className = cells[3].textContent.toLowerCase();
        const subjectCode = cells[4].textContent.toLowerCase();

        let showRow = true;

        if (filterSubject && !subjectCode.includes(filterSubject)) showRow = false;
        if (filterClass && !className.includes(filterClass)) showRow = false;
        if (filterDate && date !== filterDate) showRow = false;
        if (filterStudent && !studentId.includes(filterStudent) && !studentName.includes(filterStudent)) showRow = false;

        row.style.display = showRow ? '' : 'none';
        
        if (showRow) {
            visibleRowCount++;
        }
    }

    // If no rows are visible after filtering, show "no records found" message
    if (visibleRowCount === 0) {
        const noRecordsRow = document.createElement('tr');
        noRecordsRow.className = 'no-records-message';
        noRecordsRow.innerHTML = `
            <td colspan="8" style="text-align: center; padding: 40px; color: #e74c3c;">
                <i class="fas fa-search"></i><br>
                <strong>No student records found</strong><br>
                <small>Try adjusting your search criteria</small>
            </td>
        `;
        tbody.appendChild(noRecordsRow);
    }
}


// Load All Attendance Records
async function loadAllAttendanceRecords() {
    const tbody = document.getElementById('attendanceTableBody');
    
    try {
        const response = await fetch('/api/all-attendance-records/');
        if (!response.ok) {
            throw new Error('Failed to fetch attendance records');
        }
        
        const records = await response.json();
        
        if (records.length === 0) {
            tbody.innerHTML = ` 
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #7f8c8d;">
                        No attendance records found.
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        records.forEach(record => {
            const statusClass = record.status.toLowerCase().replace(/\s+/g, '-');
            html += `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.student_id}</td>
                    <td>${record.student_name}</td>
                    <td>${record.class_name || 'N/A'}</td>
                    <td>${record.subject_code}</td>
                    <td><span class="status-badge status-${statusClass}">${record.status}</span></td>
                    <td>${record.time_slot}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-warning" onclick="editRecord(${record.id})">✏️ Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteRecord(${record.id})">🗑️ Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading attendance records:', error);
        tbody.innerHTML = ` 
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #f8d7da;">
                    Error loading attendance records.
                </td>
            </tr>
        `;
    }
}

// Search Student Records
async function searchStudentRecords() {
    const searchTerm = document.getElementById('searchStudent').value.trim();
    const container = document.getElementById('editableRecords');
    
    if (searchTerm.length < 2) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><p>Enter at least 2 characters to search for records.</p></div>';
        return;
    }
    
    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Searching records...</div>';
    
    try {
        const response = await fetch(`/api/search-student-records/?q=${encodeURIComponent(searchTerm)}`);
        if (!response.ok) {
            throw new Error('Failed to search records');
        }
        
        const records = await response.json();
        
        if (records.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><p>No records found for this search term.</p></div>';
            return;
        }
        
        let html = '<h5><i class="fas fa-search"></i> Search Results:</h5>';
        html += '<table class="attendance-table"><thead><tr><th>Date</th><th>Student</th><th>Class</th><th>Subject</th><th>Status</th><th>Time Slot</th><th>Actions</th></tr></thead><tbody>';
        
        records.forEach(record => {
            const statusClass = record.status.toLowerCase().replace(/\s+/g, '-');
            html += `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.student_name} (${record.student_id})</td>
                    <td>${record.class_name || 'N/A'}</td>
                    <td>${record.subject_code}</td>
                    <td><span class="status-badge status-${statusClass}">${record.status}</span></td>
                    <td>${record.time_slot}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-warning" onclick="editRecord(${record.id})">✏️ Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteRecord(${record.id})">🗑️ Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error searching records:', error);
        container.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error searching records.</div>';
    }
}

// Edit Attendance Record
async function editRecord(recordId) {
    try {
        const response = await fetch(`/api/attendance-record/${recordId}/`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch record');
        }
        
        const record = await response.json();

        document.getElementById('editRecordId').value = record.id;
        document.getElementById('editStudentName').value = record.student_name;
        document.getElementById('editSubject').value = record.subject_code;
        document.getElementById('editDate').value = record.date;
        document.getElementById('editStatus').value = record.status;
        document.getElementById('editTimeSlot').value = record.time_slot;

        // Clear any previous messages
        document.getElementById('editFormMessage').innerHTML = '';

        document.getElementById('editModal').style.display = 'block';

    } catch (error) {
        console.error('Error loading record:', error);
        alert('Error loading record: ' + error.message);
    }
}

// Delete Attendance Record
async function deleteRecord(recordId) {
    // Show confirmation dialog
    const isConfirmed = confirm('Are you sure you want to delete this attendance record? This action cannot be undone.');
    
    if (!isConfirmed) {
        return;
    }

    try {
        const response = await fetch(`/api/delete-attendance-record/${recordId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete record');
        }

        const result = await response.json();

        if (result.success) {
            // Show success message
            alert('Attendance record deleted successfully!');
            
            // Refresh the current view
            if (document.getElementById('viewAttendanceSection').style.display !== 'none') {
                loadAllAttendanceRecords();
            }
            
            if (document.getElementById('editAttendanceSection').style.display !== 'none') {
                // Re-search if there's a search term
                const searchTerm = document.getElementById('searchStudent').value.trim();
                if (searchTerm.length >= 2) {
                    searchStudentRecords();
                }
            }
        } else {
            throw new Error(result.message || 'Failed to delete record');
        }

    } catch (error) {
        console.error('Error deleting record:', error);
        alert('Error deleting record: ' + error.message);
    }
}

// Submit Edit Form
async function submitEditForm(event) {
    event.preventDefault(); // Prevent default form submission
    
    const form = event.target;
    const formData = new FormData(form);
    const recordId = document.getElementById('editRecordId').value;
    const messageDiv = document.getElementById('editFormMessage');
    const submitBtn = form.querySelector('.btn-save');
    
    // Clear previous messages
    messageDiv.innerHTML = '';
    
    // Show loading state
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '⏳ Saving...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/attendance-record/${recordId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to update record');
        }
        
        // Show success message
        messageDiv.innerHTML = '<div class="success-message">Attendance record updated successfully!</div>';
        
        // Reset button
        submitBtn.innerHTML = '✅ Saved!';
        
        // Close modal after a short delay
        setTimeout(() => {
            closeEditModal();
            
            // Refresh the current view
            if (document.getElementById('viewAttendanceSection').style.display !== 'none') {
                loadAllAttendanceRecords();
            }
            
            if (document.getElementById('editAttendanceSection').style.display !== 'none') {
                // Re-search if there's a search term
                const searchTerm = document.getElementById('searchStudent').value.trim();
                if (searchTerm.length >= 2) {
                    searchStudentRecords();
                }
            }
        }, 1500);
        
    } catch (error) {
        console.error('Error updating record:', error);
        messageDiv.innerHTML = '<div class="error-message">Error updating record: ' + error.message + '</div>';
        
        // Reset button
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Close Modal
function closeEditModal() {
    const modal = document.getElementById('editModal');
    const modalContent = modal.querySelector('.modal-content');
    const form = document.getElementById('editForm');
    const submitBtn = form.querySelector('.btn-save');
    const messageDiv = document.getElementById('editFormMessage');
    
    // Hide modal immediately for better UX
    modal.style.display = 'none';
    
    // Reset scroll position
    if (modalContent) {
        modalContent.scrollTop = 0;
    }
    
    // Reset form and messages
    if (messageDiv) {
        messageDiv.innerHTML = '';
    }
    
    if (submitBtn) {
        submitBtn.innerHTML = '💾 Save Changes';
        submitBtn.disabled = false;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}